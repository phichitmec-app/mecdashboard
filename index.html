<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Student Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .card { @apply bg-white rounded-lg shadow-md p-6; }
    </style>
</head>
<body>

    <div class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">üìä MedSchool Dashboard</h1>
                    <p class="text-sm text-gray-500">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏¥‡∏™‡∏¥‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏™‡∏±‡∏°‡∏§‡∏ó‡∏ò‡∏¥‡πå</p>
                </div>

                <div class="bg-blue-50 px-4 py-2 rounded-lg border border-blue-100">
                    <p class="text-xs font-bold text-blue-600 mb-1 uppercase tracking-wider">‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ô‡∏¥‡∏™‡∏¥‡∏ï (Filter Status):</p>
                    <div class="flex flex-wrap gap-4" id="filter-container">
                        <label class="inline-flex items-center cursor-pointer hover:bg-blue-100 px-2 py-1 rounded transition">
                            <input type="checkbox" class="status-filter form-checkbox h-5 w-5 text-blue-600 rounded" value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤" checked>
                            <span class="ml-2 text-sm text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer hover:bg-blue-100 px-2 py-1 rounded transition">
                            <input type="checkbox" class="status-filter form-checkbox h-5 w-5 text-green-600 rounded" value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏ô" checked>
                            <span class="ml-2 text-sm text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏ô</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer hover:bg-blue-100 px-2 py-1 rounded transition">
                            <input type="checkbox" class="status-filter form-checkbox h-5 w-5 text-purple-600 rounded" value="‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤" checked>
                            <span class="ml-2 text-sm text-gray-700">‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer hover:bg-blue-100 px-2 py-1 rounded transition">
                            <input type="checkbox" class="status-filter form-checkbox h-5 w-5 text-red-600 rounded" value="‡∏•‡∏≤‡∏≠‡∏≠‡∏Å" checked>
                            <span class="ml-2 text-sm text-gray-700">‡∏•‡∏≤‡∏≠‡∏≠‡∏Å</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <div id="loading" class="text-center py-20">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Database...</p>
        </div>

        <div id="dashboard-content" class="hidden space-y-6">

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card border-l-4 border-blue-500">
                    <p class="text-sm text-gray-500">‡∏ô‡∏¥‡∏™‡∏¥‡∏ï‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á)</p>
                    <h2 class="text-3xl font-bold text-gray-800" id="kpi-total">0</h2>
                </div>
                <div class="card border-l-4 border-red-400">
                    <p class="text-sm text-gray-500">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</p>
                    <h2 class="text-3xl font-bold text-gray-800" id="kpi-health">0</h2>
                    <p class="text-xs text-gray-400 mt-1">‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</p>
                </div>
                <div class="card border-l-4 border-green-500">
                    <p class="text-sm text-gray-500">‡∏ú‡πà‡∏≤‡∏ô NL1 (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</p>
                    <h2 class="text-3xl font-bold text-gray-800" id="kpi-nl1">0%</h2>
                </div>
                <div class="card border-l-4 border-purple-500">
                    <p class="text-sm text-gray-500">‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡πâ‡∏ß</p>
                    <h2 class="text-3xl font-bold text-gray-800" id="kpi-grad">0</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="card lg:col-span-1">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">üìÖ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏¥‡∏™‡∏¥‡∏ï‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∏‡πà‡∏ô‡∏õ‡∏µ</h3>
                    <div id="chart-years" class="h-64"></div>
                </div>
                
                <div class="card lg:col-span-2">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">üèÜ ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÉ‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ä‡∏≤‡∏ä‡∏µ‡∏û (NL)</h3>
                    <div id="chart-exams" class="h-64"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">üó∫Ô∏è 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏ó‡∏∏‡∏ô</h3>
                    <div id="chart-province" class="h-80"></div>
                </div>

                <div class="card">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">üéì ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏∏‡∏ô</h3>
                    <div id="chart-scholarship" class="h-80 flex items-center justify-center"></div>
                </div>
            </div>

        </div>
    </main>

 <script>
        // --- 1. CONFIGURATION ---
        const SUPABASE_URL = 'https://YOUR_PROJECT_ID.supabase.co'; // üî¥ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const SUPABASE_KEY = 'YOUR_ANON_KEY'; // üî¥ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÉ‡∏™‡πà Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        const TABLE_NAME = 'students'; 

        // --- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏Å‡∏±‡∏ö Library ---
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Global Variables
        let allData = [];
        let charts = {}; 

        // --- 2. MAIN LOGIC ---
        
        async function initDashboard() {
            try {
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Supabase (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ db ‡πÅ‡∏ó‡∏ô)
                const { data, error } = await db
                    .from(TABLE_NAME)
                    .select('*');

                if (error) throw error;

                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏à‡∏£‡∏¥‡∏á‡πÑ‡∏´‡∏°
                console.log("Data loaded:", data.length, "rows"); 

                allData = data;
                
                // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                updateDashboard();

                // ‡∏õ‡∏¥‡∏î Loading ‡πÄ‡∏õ‡∏¥‡∏î Content
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard-content').classList.remove('hidden');

            } catch (err) {
                console.error('Error fetching data:', err);
                // ‡πÅ‡∏™‡∏î‡∏á Error ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î‡πÜ
                document.getElementById('loading').innerHTML = `
                    <div class="text-red-500 bg-red-50 p-4 rounded-lg">
                        <p class="font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!</p>
                        <p>${err.message}</p>
                        <p class="text-sm text-gray-500 mt-2">Check Console for details</p>
                    </div>`;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
        function updateDashboard() {
            const checkboxes = document.querySelectorAll('.status-filter:checked');
            const selectedStatuses = Array.from(checkboxes).map(cb => cb.value);

            const filteredData = allData.filter(item => {
                // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô null ‡∏´‡∏£‡∏∑‡∏≠ undefined
                const status = item.studystatus || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'; 
                return selectedStatuses.includes(status);
            });

            renderKPI(filteredData);
            renderChartYears(filteredData);
            renderChartExams(filteredData);
            renderChartProvince(filteredData);
            renderChartScholarship(filteredData);
        }

        // --- 3. RENDER FUNCTIONS ---

        function renderKPI(data) {
            document.getElementById('kpi-total').innerText = data.length.toLocaleString();

            const healthRiskCount = data.filter(item => item.med_condition && item.med_condition !== '-' && item.med_condition.trim() !== '').length;
            document.getElementById('kpi-health').innerText = healthRiskCount.toLocaleString();

            const nl1Takers = data.filter(item => item.nl1 === '‡∏ú‡πà‡∏≤‡∏ô' || item.nl1 === '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô');
            const nl1Pass = nl1Takers.filter(item => item.nl1 === '‡∏ú‡πà‡∏≤‡∏ô').length;
            const nl1Rate = nl1Takers.length > 0 ? ((nl1Pass / nl1Takers.length) * 100).toFixed(1) : 0;
            document.getElementById('kpi-nl1').innerText = `${nl1Rate}%`;

            const gradCount = data.filter(item => item.studystatus === '‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤').length;
            document.getElementById('kpi-grad').innerText = gradCount.toLocaleString();
        }

        function renderChartYears(data) {
            const yearCounts = {};
            data.forEach(item => {
                const year = item.stu_year || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                yearCounts[year] = (yearCounts[year] || 0) + 1;
            });

            const sortedYears = Object.keys(yearCounts).sort();
            const counts = sortedYears.map(y => yearCounts[y]);

            const options = {
                series: [{ name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏¥‡∏™‡∏¥‡∏ï', data: counts }],
                chart: { type: 'bar', height: 250, toolbar: { show: false } },
                xaxis: { categories: sortedYears },
                colors: ['#3b82f6'],
                plotOptions: { bar: { borderRadius: 4 } }
            };
            updateOrRenderChart('chart-years', options);
        }

        function renderChartExams(data) {
            const exams = ['nl1', 'nl2', 'nl3osce', 'nl3meq', 'nl3longcase'];
            const labels = ['NL1', 'NL2', 'NL3 OSCE', 'NL3 MEQ', 'NL3 Longcase'];
            
            const passData = [];
            const failData = [];

            exams.forEach(examField => {
                const pass = data.filter(d => d[examField] === '‡∏ú‡πà‡∏≤‡∏ô').length;
                const fail = data.filter(d => d[examField] === '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô').length;
                passData.push(pass);
                failData.push(fail);
            });

            const options = {
                series: [
                    { name: '‡∏ú‡πà‡∏≤‡∏ô', data: passData },
                    { name: '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô', data: failData }
                ],
                chart: { type: 'bar', height: 250, stacked: true, toolbar: { show: false } },
                xaxis: { categories: labels },
                colors: ['#22c55e', '#ef4444'], 
                plotOptions: { bar: { borderRadius: 4 } },
                dataLabels: { enabled: false }
            };
            updateOrRenderChart('chart-exams', options);
        }

        function renderChartProvince(data) {
            const provCounts = {};
            data.forEach(item => {
                const prov = item.scholarship_province;
                // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô null, ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô '-', ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á)
                if(prov && prov !== '-' && prov.trim() !== '') {
                    provCounts[prov] = (provCounts[prov] || 0) + 1;
                }
            });

            const sortedProv = Object.entries(provCounts)
                .sort((a, b) => b[1] - a[1]) // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                .slice(0, 10); // ‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà 10 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
            
            const categories = sortedProv.map(item => item[0]);
            const counts = sortedProv.map(item => item[1]);

            const options = {
                series: [{ name: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', data: counts }],
                chart: { type: 'bar', height: 320, toolbar: { show: false } },
                plotOptions: { bar: { horizontal: true, borderRadius: 4 } },
                xaxis: { categories: categories },
                colors: ['#8b5cf6']
            };
            updateOrRenderChart('chart-province', options);
        }

        function renderChartScholarship(data) {
            const scholarCounts = {};
            data.forEach(item => {
                const type = item.scholarship_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                scholarCounts[type] = (scholarCounts[type] || 0) + 1;
            });

            const options = {
                series: Object.values(scholarCounts),
                labels: Object.keys(scholarCounts),
                chart: { type: 'donut', height: 320 },
                colors: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1'],
                legend: { position: 'bottom' }
            };
            updateOrRenderChart('chart-scholarship', options);
        }

        function updateOrRenderChart(id, options) {
            if (charts[id]) {
                charts[id].updateOptions(options);
            } else {
                charts[id] = new ApexCharts(document.querySelector(`#${id}`), options);
                charts[id].render();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initDashboard();
            document.querySelectorAll('.status-filter').forEach(cb => {
                cb.addEventListener('change', updateDashboard);
            });
        });
    </script>
</body>
</html>
